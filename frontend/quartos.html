<!DOCTYPE html>
<html lang="pt-br">
  <head>
    <meta charset="UTF-8" />
    <title>Quartos - Guia de Informa√ß√µes</title>
    <script>
      if (!sessionStorage.getItem('user') || !sessionStorage.getItem('token')) {
        window.location.replace('login.html');
      }
    </script>
    <link rel="icon" type="image/x-icon" href="imagens/logo_branco .svg" />
    <link
      rel="icon"
      type="image/png"
      sizes="32x32"
      href="imagens/logo_branco .svg"
    />
    <link rel="logo" href="imagens/logo_branco .svg" />
    <!-- Scripts de autentica√ß√£o e UI -->
    <script src="js/auth.js"></script>
    <script src="js/ui.js"></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      body {
        font-family: "Inter", sans-serif;
        background-color: var(--background-color); /* Corre√ß√£o: use var() */
        color: var(--text-color);
        display: flex; /* Mant√©m o body como flex container */
      }

      /* Removido container, usando main-flex que j√° existe */

      /* Estrutura principal com Flexbox */

      /* --- ESTILOS PADR√ÉO DA SIDEBAR (COPIADOS DE CALENDARIO.HTML) --- */
      .sidebar {
        width: 240px;
        background-color: #fff;
        padding: 2rem 1.5rem;
        display: flex;
        flex-direction: column;
        border-right: 1px solid var(--border-color);
        flex-shrink: 0;
        min-height: 100vh; /* Garante altura total */
      }
      .sidebar-header {
        margin-bottom: 2.5rem;
      }
      .logo {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--heading-color);
        text-align: center;
      }
      .logo img {
        height: auto;
      }
      .date-time {
        text-align: center;
        font-size: 0.9rem;
        margin-top: 0.5rem;
        line-height: 1.4;
        white-space: pre-line;
        min-height: 3rem;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .nav-menu {
        flex-grow: 1;
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
      }
      .menu-btn {
        display: flex;
        align-items: center;
        padding: 0.75rem 1rem;
        border-radius: 8px;
        text-decoration: none;
        color: var(--text-color);
        font-weight: 500;
        transition: background-color 0.2s, color 0.2s;
        /* Remove margin-bottom, j√° que gap no nav-menu cuida disso */
      }
      .menu-btn:hover,
      .menu-btn.active {
        background-color: var(--primary-color);
        color: #fff;
      }

      /* Estilos do User Card */
      .user-card {
        margin-top: auto;
        padding-top: 1.5rem;
        border-top: 1px solid var(--border-color);
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
      }

      .user-info {
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
      }

      .user-name {
        font-weight: 600;
        color: var(--heading-color);
        font-size: 0.95rem;
      }

      .user-role {
        font-size: 0.8rem;
        color: var(--text-color);
        opacity: 0.8;
      }

      .logout-btn {
        background-color: #e53e3e;
        color: white;
        border: none;
        padding: 0.6rem 1rem;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 600;
        font-size: 0.85rem;
        transition: all 0.2s;
      }

      .logout-btn:hover {
        background-color: #c53030;
      }

      :root {
        --background-color: #f4f7fa;
        --card-bg: #ffffff;
        --text-color: #4a5568;
        --heading-color: #1a202c;
        --primary-color: #4a90e2;
        --border-color: #e2e8f0;
        --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      }
      
      .container { max-width: 1000px; margin: 32px auto; background: var(--card-bg); border-radius: 12px; box-shadow: var(--shadow); padding: 24px; }

      /* Cabe√ßalho simples */
      .checkout_screen_back_arrow { text-decoration: none; color: var(--primary-color); font-weight: 600; }
      h2 { color: var(--heading-color); margin: 12px 0 18px; font-size: 1.6rem; }

      .page-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 12px;
        margin-bottom: 10px;
      }

      .cadastro-btn {
        background-color: var(--primary-color);
        color: white;
        padding: 0.75rem 1.5rem;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
        font-size: 0.9rem;
        box-shadow: var(--shadow);
        transition: transform 0.15s ease, filter 0.2s ease;
      }

      .cadastro-btn:hover {
        filter: brightness(0.95);
        transform: translateY(-1px);
      }

      /* Tabs minimalistas */
      .tabs { display: flex; gap: 6px; border-bottom: 1px solid var(--border-color); margin-bottom: 16px; overflow-x: auto; }
      .tab { background: transparent; border: 1px solid transparent; border-bottom: 2px solid transparent; padding: 10px 14px; font-size: 0.95rem; color: var(--text-color); cursor: pointer; border-radius: 6px 6px 0 0; }
      .tab:hover { background: #f8fafc; }
      .tab.active { color: var(--primary-color); border-color: var(--border-color); border-bottom-color: var(--primary-color); font-weight: 600; }

      /* Conte√∫do da tab como card */
      .tab-content { background: #f9fafb; border: 1px solid var(--border-color); border-top: none; border-radius: 0 0 10px 10px; padding: 18px; min-height: 160px; box-shadow: inset 0 1px 0 rgba(0,0,0,0.02); }
      .tab-content h3 { margin: 0 0 6px; color: var(--heading-color); }
      .tab-content p { margin: 6px 0; color: var(--text-color); font-size: 0.95rem; }

      /* Tabela moderna */
      table { width: 100%; border-collapse: collapse; margin-top: 18px; background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 8px; overflow: hidden; }
      thead th { background: #f8f9fa; color: var(--heading-color); font-weight: 600; text-align: left; padding: 10px; border-bottom: 1px solid var(--border-color); }
      tbody td { padding: 10px; border-top: 1px solid var(--border-color); font-size: 0.95rem; }
      tbody tr:hover { background: #f9fafb; }

      /* Modal minimalista */
      #modalConsumo { display: none; position: fixed; z-index: 1000; inset: 0; background-color: rgba(0,0,0,0.4); padding-top: 60px; }
      #modalConsumo div { background: var(--card-bg); margin: 5% auto; padding: 20px; border: 1px solid var(--border-color); width: 90%; max-width: 520px; border-radius: 10px; box-shadow: var(--shadow); }
      #modalConsumo h3 { margin-top: 0; color: var(--heading-color); }
      #modalConsumo label { display: block; margin: 12px 0 6px; color: var(--text-color); font-weight: 600; }
      #modalConsumo input, #modalConsumo select { width: 100%; padding: 10px; margin-bottom: 12px; border: 1px solid var(--border-color); border-radius: 8px; background: #fff; color: var(--text-color); }
      #modalConsumo button { background-color: var(--primary-color); color: #fff; border: none; padding: 10px 14px; border-radius: 8px; cursor: pointer; font-weight: 600; }
      #modalConsumo button:hover { filter: brightness(0.95); }

      /* Bot√µes inline no conte√∫do */
      button { background: var(--primary-color); color: #fff; border: none; padding: 8px 12px; border-radius: 8px; cursor: pointer; font-weight: 600; }
      button#btn-editar-quarto-info { background: #6b7280; }
      button#btn-interditar-quarto-info { background: #ef4444; }
      button#btn-salvar-quarto { background: #10b981; }
      button#btn-cancelar-edicao { background: #9ca3af; }
      #btn-liberar-quarto { background: #10b981; }

      /* Se√ß√£o de depend√™ncias (consumos) */
      #dependencias-quarto { margin-top: 18px; background: #f9fafb; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; }

      @media (max-width: 600px) {
        .container { margin: 16px; padding: 16px; }
        .tab { padding: 8px 10px; font-size: 0.9rem; }
        .tab-content { padding: 14px; }
      }
    </style>
  </head>
  <body>
      <aside class="sidebar">
        <div class="sidebar-header">
          <div class="logo">
            <img src="imagens/LOGO HOTEL azul .svg.svg" alt="Logo Hotel" />
          </div> <div class="date-time" id="dateTime"></div>
        </div>
        <nav class="nav-menu">
          <a href="index.html" class="menu-btn">üè† √çnicio</a>
          <a href="checkin.html" class="menu-btn">üì• Check-in</a>
          <a href="checkout.html" class="menu-btn">üì§ Check-out</a>
          <a href="clientes.html" class="menu-btn">üë§ Clientes</a>
          <a href="quartos.html" class="menu-btn active">üõèÔ∏è Quartos</a>
          <a href="reservas.html" class="menu-btn">üìã Reservas</a>
          <a href="produtos.html" class="menu-btn">üõí Produtos</a>
          <a href="calendario.html" class="menu-btn">üìÖ Calend√°rio</a>
          <a href="gerenciamento_usuarios.html" class="menu-btn" id="usuariosMenuBtn" style="display: none;">üë• Usu√°rios</a>
        </nav>
        <div class="user-card">
          <div class="user-info">
            <div class="user-name" id="sidebarUserName">‚Äî</div>
            <div class="user-role" id="sidebarUserRole">padr√£o</div>
          </div>
          <button class="logout-btn" id="sidebarLogoutBtn">Sair</button>
        </div>
      </aside>
      <div class="container">
      <div class="page-header">
        <div>
          <a href="#" class="checkout_screen_back_arrow" onclick="VoltarPagina()"
            >‚Üê</a
          >
          <h2 style="color: #357abd; margin-bottom: 6px">Quartos Cadastrados</h2>
        </div>
        <button class="cadastro-btn" onclick="window.location.href='cadastro_quarto.html'">
          + Cadastrar Quarto
        </button>
      </div>
      <div class="tabs" id="tabs"></div>
      <div class="tab-content" id="tabContent">
        <p>Selecione um quarto acima para ver as informa√ß√µes.</p>
      </div>
      <table style="width: 100%; border-collapse: collapse; margin-top: 20px">
        <thead>
          <tr>
            <th style="border: 1px solid #ddd; padding: 8px">N√∫mero</th>
            <th style="border: 1px solid #ddd; padding: 8px">Tipo</th>
            <th style="border: 1px solid #ddd; padding: 8px">Descri√ß√£o</th>
            <th style="border: 1px solid #ddd; padding: 8px">Valor Di√°ria</th>
            <th style="border: 1px solid #ddd; padding: 8px">Status</th>
            <th style="border: 1px solid #ddd; padding: 8px">A√ß√µes</th>
          </tr>
        </thead>
        <tbody id="quartos-tbody"></tbody>
      </table>

    <div id="modalConsumo" style="display:none;">
      <div>
        <h3>Adicionar Consumo</h3>
        <label>Produto:
          <select id="consumoProduto"></select>
        </label>
        <label>Quantidade:
          <input type="number" id="consumoQuantidade" min="1" />
        </label>
        <label>Pre√ßo Unit√°rio:
          <input type="number" id="consumoValor" step="0.01" min="0" />
        </label>
        <button onclick="salvarConsumo()">Salvar</button>
        <button onclick="fecharModalConsumo()">Cancelar</button>
      </div>
    </div>

    <script>
      // Script para data/hora (Adicionado para completar a sidebar)
      function updateDateTime() {
        const now = new Date();
        const date = now.toLocaleDateString("pt-BR", {
          weekday: "long",
          year: "numeric",
          month: "long",
          day: "numeric",
        });
        const time = now.toLocaleTimeString("pt-BR", {
          hour: "2-digit",
          minute: "2-digit",
        });
        const dateTimeEl = document.getElementById("dateTime");
        if (dateTimeEl) {
           dateTimeEl.innerHTML = `${date}<br>${time}`;
        }
      }
      updateDateTime();
      setInterval(updateDateTime, 1000);


      function VoltarPagina() {
        window.location.href = "index.html";
      }
      // Fun√ß√£o para buscar os quartos cadastrados do backend (com JOIN)
      async function buscarQuartos() {
  const resp = await fetch("/api/quartos");
  if (!resp.ok) throw new Error("Erro ao buscar quartos");
  return await resp.json();
}

      async function buscarTiposQuarto() {
  const resp = await fetch("/api/tipos-quarto");
  if (!resp.ok) return [];
  return await resp.json();
}

      // Fun√ß√£o para renderizar as guias/tabs
      function renderTabs(quartos) {
        const tabsDiv = document.getElementById("tabs");
        tabsDiv.innerHTML = "";
        if (quartos.length === 0) {
          tabsDiv.innerHTML =
            '<span style="color:#888;">Nenhum quarto cadastrado.</span>';
          document.getElementById("tabContent").innerHTML =
            "<p>Nenhum quarto encontrado no sistema.</p>";
          return;
        }
        quartos.forEach((quarto, idx) => {
          const btn = document.createElement("button");
          btn.className = "tab" + (idx === 0 ? " active" : "");
          btn.textContent = `Quarto ${quarto.numero}`;
          btn.onclick = () => selecionarTab(idx, quartos);
          tabsDiv.appendChild(btn);
        });
        selecionarTab(0, quartos);
      }

// Fun√ß√£o para mostrar as informa√ß√µes do quarto selecionado
function selecionarTab(idx, quartos) {
  document.querySelectorAll(".tab").forEach((tab, i) => {
    tab.classList.toggle("active", i === idx);
  });
  const quarto = quartos[idx];
  const contentDiv = document.getElementById("tabContent");

  let acoesExtras = '';
  if (quarto.status === 'interditado') {
    acoesExtras = `<button id="btn-liberar-quarto" style="background-color: #28a745; color: white; margin-left: 10px;">Liberar Quarto</button>`;
  }

  contentDiv.innerHTML = `
    <div style="display: flex; justify-content: space-between; align-items: flex-start;">
      <div>
        <h3>Quarto ${quarto.numero}</h3>
        <p><strong>Descri√ß√£o:</strong> <span id="desc-q">${quarto.descricao || "---"}</span></p>
        <p><strong>Tipo:</strong> <span id="tipo-q">${quarto.tipo || "---"}</span></p>
        <p><strong>Valor da di√°ria:</strong> R$ <span id="valor-q">${Number(quarto.valor_diaria || 0).toFixed(2)}</span></p>
        <p><strong>Status:</strong> <span id="status-q" style="font-weight: bold; color: ${quarto.status === 'interditado' ? 'red' : 'inherit'};">${quarto.status || "---"}</span></p>
        <button onclick="abrirModalConsumo(${quarto.numero})">Adicionar Consumo</button>
      </div>
      <div>
        <button id="btn-editar-quarto-info">Editar</button>
        ${acoesExtras}
        <span id="acoes-quarto-info" style="display:none; flex-direction: column; gap: 8px; margin-top: 12px;">
          <button id="btn-salvar-quarto" style="margin-bottom:4px;">Salvar</button>
          <button id="btn-cancelar-edicao" style="margin-bottom:4px; background-color: #aaa;">Cancelar</button>
          <button id="btn-interditar-quarto-info" style="margin-bottom:4px;">Interditar</button>
          <button id="btn-excluir-quarto-info">Excluir</button>
        </span>
      </div>
    </div>
    <div id="dependencias-quarto" style="margin-top:24px; background:#f6f6f6; padding:12px; border-radius:8px;"></div>
  `;

  document.getElementById("btn-editar-quarto-info").onclick = async function() {
    const tipos = await buscarTiposQuarto();
    const tipoOptions = tipos.map(t =>
      `<option value="${t.id}"${t.tipo === quarto.tipo ? " selected" : ""}>${t.tipo}</option>`
    ).join('');
    document.getElementById("desc-q").outerHTML = `<input id="edit-desc-q" value="${quarto.descricao || ""}" style="width:180px;">`;
    document.getElementById("tipo-q").outerHTML = `<select id="edit-tipo-q">${tipoOptions}</select>`;
    document.getElementById("valor-q").outerHTML = `<input id="edit-valor-q" type="number" min="0" step="0.01" value="${Number(quarto.valor_diaria || 0).toFixed(2)}" style="width:90px;">`;
    document.getElementById("status-q").outerHTML = `<select id="edit-status-q">
      <option value="disponivel"${quarto.status === "disponivel" ? " selected" : ""}>dispon√≠vel</option>
      <option value="ocupado"${quarto.status === "ocupado" ? " selected" : ""}>ocupado</option>
      <option value="interditado"${quarto.status === "interditado" ? " selected" : ""}>interditado</option>
      <option value="manutencao"${quarto.status === "manutencao" ? " selected" : ""}>manutencao</option>
    </select>`;
    document.getElementById("acoes-quarto-info").style.display = "flex";
    this.style.display = "none";
  };

  setTimeout(() => {
    // Adiciona o evento de clique para o novo bot√£o "Liberar"
    const btnLiberar = document.getElementById("btn-liberar-quarto");
    if (btnLiberar) {
      btnLiberar.onclick = async function() {
        if (!confirm('Tem certeza que deseja liberar este quarto? Ele voltar√° ao status "dispon√≠vel".')) return;
        
        const dadosParaEnviar = {
          tipo_id: quarto.tipo_id,
          descricao: quarto.descricao,
          valor_diaria: quarto.valor_diaria,
          status: 'disponivel'
        };

        const resp = await fetch(`/api/quartos/${quarto.numero}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(dadosParaEnviar)
        });

        if (resp.ok) {
          alert('Quarto liberado com sucesso!');
          const quartosAtualizados = await buscarQuartos();
          renderTabs(quartosAtualizados);
          // --- MELHORIA ADICIONADA AQUI ---
          const tbody = document.getElementById("quartos-tbody");
          tbody.innerHTML = "";
          quartosAtualizados.forEach(q => {
            tbody.innerHTML += `
              <tr>
                <td>${q.numero}</td><td>${q.tipo}</td><td>${q.descricao || ''}</td>
                <td>R$ ${Number(q.valor_diaria).toFixed(2)}</td><td>${q.status}</td><td></td>
              </tr>`;
          });
        } else {
          const erro = await resp.json();
          alert(erro.message || 'Erro ao liberar o quarto.');
        }
      };
    }

    const btnSalvar = document.getElementById("btn-salvar-quarto");
    if (btnSalvar) {
      btnSalvar.onclick = async function() {
        const numero = quarto.numero;
        const tipo_id = Number(document.getElementById("edit-tipo-q").value);
        const status = document.getElementById("edit-status-q").value;
        const descricao = document.getElementById("edit-desc-q").value;
        const valor_diaria = Number(document.getElementById("edit-valor-q").value);

        if (!tipo_id || !descricao || !valor_diaria || !status) {
          alert("Preencha todos os campos antes de salvar.");
          return;
        }

        const resp = await fetch(`/api/quartos/${numero}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ tipo_id, descricao, valor_diaria, status })
        });
        if (resp.ok) {
          alert('Quarto atualizado!');
          const quartosAtualizados = await buscarQuartos();
          renderTabs(quartosAtualizados);
          const tbody = document.getElementById("quartos-tbody");
          tbody.innerHTML = "";
          quartosAtualizados.forEach(q => {
            tbody.innerHTML += `
              <tr>
                <td>${q.numero}</td><td>${q.tipo}</td><td>${q.descricao || ''}</td>
                <td>R$ ${Number(q.valor_diaria).toFixed(2)}</td><td>${q.status}</td><td></td>
              </tr>`;
          });
        } else {
          const erro = await resp.json();
          alert(erro.message || 'Erro ao atualizar quarto');
        }
      };
    }

    const btnCancelar = document.getElementById("btn-cancelar-edicao");
    if (btnCancelar) {
      btnCancelar.onclick = function() {
        selecionarTab(idx, quartos);
      };
    }

    const btnInterditar = document.getElementById("btn-interditar-quarto-info");
    if (btnInterditar) {
      btnInterditar.onclick = async function() {
        const dadosParaEnviar = {
          tipo_id: Number(document.getElementById("edit-tipo-q").value),
          descricao: document.getElementById("edit-desc-q").value,
          valor_diaria: Number(document.getElementById("edit-valor-q").value),
          status: 'interditado'
        };

        if (!dadosParaEnviar.tipo_id || !dadosParaEnviar.descricao || !dadosParaEnviar.valor_diaria) {
          alert("Os campos de tipo, descri√ß√£o e valor devem estar preenchidos para interditar.");
          return;
        }

        const numeroDoQuarto = quarto.numero;
        const resp = await fetch(`/api/quartos/${numeroDoQuarto}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(dadosParaEnviar)
        });

        if (resp.ok) {
          alert('Quarto interditado com sucesso!');
          const quartosAtualizados = await buscarQuartos();
          renderTabs(quartosAtualizados);
          // --- MELHORIA ADICIONADA AQUI ---
          const tbody = document.getElementById("quartos-tbody");
          tbody.innerHTML = "";
          quartosAtualizados.forEach(q => {
            tbody.innerHTML += `
              <tr>
                <td>${q.numero}</td><td>${q.tipo}</td><td>${q.descricao || ''}</td>
                <td>R$ ${Number(q.valor_diaria).toFixed(2)}</td><td>${q.status}</td><td></td>
              </tr>`;
          });
        } else {
          const erro = await resp.json();
          alert(erro.message || 'Erro ao interditar o quarto.');
        }
      };
    }
    const btnExcluir = document.getElementById("btn-excluir-quarto-info");
    if (btnExcluir) {
      btnExcluir.onclick = async function() {
        if (!confirm('Tem certeza que deseja excluir este quarto e todas as reservas/consumos ligados a ele?')) return;
        await excluirTudoDoQuarto(quarto.numero);
      };
    }
  }, 100);
  mostrarConsumosHospedeAtual(quarto.numero);
}
      function abrirModalConsumo(numero) {
        window.quartoSelecionado = numero;
        const modal = document.getElementById("modalConsumo");
        modal.style.display = "block";

        // Buscar produtos do backend e preencher o select
        fetch("/api/produtos")
          .then(resp => resp.json())
          .then(produtos => {
            const select = document.getElementById("consumoProduto");
            if (!produtos.length) {
              select.innerHTML = '<option disabled selected>Nenhum produto cadastrado</option>';
              document.getElementById('consumoValor').value = '';
              return;
            }
            select.innerHTML = produtos.map(p =>
              `<option value="${p.id}" data-preco="${p.preco_unitario}">${p.nome}</option>`
            ).join('');
            // Preencher pre√ßo ao selecionar produto
            select.onchange = function() {
              const preco = select.options[select.selectedIndex].getAttribute('data-preco');
              document.getElementById('consumoValor').value = preco;
            };
            // Preencher pre√ßo do primeiro produto
            document.getElementById('consumoValor').value = produtos[0].preco_unitario;
          });
      }

      function fecharModalConsumo() {
        // L√≥gica para fechar o modal de consumo
        const modal = document.getElementById("modalConsumo");
        modal.style.display = "none";
        // Limpa os campos do modal
        document.getElementById("consumoProduto").value = "";
        document.getElementById("consumoQuantidade").value = "";
        document.getElementById("consumoValor").value = "";
      }

      async function salvarConsumo() {
        const produto_id = document.getElementById("consumoProduto").value;
        const quantidade = document.getElementById("consumoQuantidade").value;
        const preco_unitario = document.getElementById("consumoValor").value;
        const numeroQuarto = window.quartoSelecionado;

        // Buscar reservaativa do quarto
        const respReserva = await fetch(`/api/reserva-ativa-quarto/${numeroQuarto}`);
        if (!respReserva.ok) {
          alert('Nenhuma reserva ativa para este quarto.');
          return;
        }
        const reserva = await respReserva.json();
        const reserva_id = reserva.id;

        if (!produto_id || !quantidade || !preco_unitario) {
          alert("Por favor, preencha todos os campos.");
          return;
        }

        try {
          const resp = await fetch("/api/consumos", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              reserva_id,
              produto_id,
              quantidade: Number(quantidade),
              preco_unitario: Number(preco_unitario)
            }),
          });
          if (!resp.ok) throw new Error("Erro ao salvar consumo");
          alert("Consumo salvo com sucesso!");
          fecharModalConsumo();
        } catch (e) {
          alert("Erro ao salvar consumo: " + e.message);
        }
      }

      async function excluirQuarto(numero) {
        if (!confirm('Tem certeza que deseja excluir este quarto?')) return;
        const resp = await fetch(`/api/quartos/${numero}`, { method: 'DELETE' });
        if (resp.ok) {
          alert('Quarto exclu√≠do!');
          // Atualize a lista de quartos
          const quartosAtualizados = await buscarQuartos();
          renderTabs(quartosAtualizados);
          const tbody = document.getElementById("quartos-tbody");
          tbody.innerHTML = "";
          quartosAtualizados.forEach(q => {
            tbody.innerHTML += `
              <tr>
                <td>${q.numero}</td>
                <td>${q.tipo}</td>
                <td>${q.descricao || ''}</td>
                <td>R$ ${Number(q.valor_diaria).toFixed(2)}</td>
                <td>${q.status}</td>
                <td></td>
              </tr>
            `;
          });
        } else {
          alert('Erro ao excluir quarto');
        }
      }

      // Inicializa√ß√£o
      document.addEventListener("DOMContentLoaded", async () => {
        const quartos = await buscarQuartos();
        renderTabs(quartos); // <-- Isso monta as tabs e a √°rea de informa√ß√µes

        const tbody = document.getElementById("quartos-tbody");
        if (!quartos.length) {
          tbody.innerHTML = '<tr><td colspan="6">Nenhum quarto cadastrado</td></tr>';
          return;
        }
        tbody.innerHTML = ""; // Limpa antes de preencher
        quartos.forEach(q => {
          tbody.innerHTML += `
            <tr>
              <td>${q.numero}</td>
              <td>${q.tipo}</td>
              <td>${q.descricao || ''}</td>
              <td>R$ ${Number(q.valor_diaria).toFixed(2)}</td>
              <td>${q.status}</td>
              <td></td>
            </tr>
          `;
        });
      });

async function excluirTudoDoQuarto(numero) {
  // 1. Buscar reservas do quarto
  const respReservas = await fetch(`/api/reservas-por-quarto?quarto_numero=${numero}`);
  const reservas = respReservas.ok ? await respReservas.json() : [];
  for (const reserva of reservas) {
    // 2. Buscar consumos da reserva
    const respConsumos = await fetch(`/api/consumos?reserva_id=${reserva.id || reserva.reserva_id}`);
    const consumos = respConsumos.ok ? await respConsumos.json() : [];
    // 3. Excluir todos os consumos
    for (const consumo of consumos) {
      await fetch(`/api/consumos/${consumo.id}`, { method: "DELETE" });
    }
    // 4. Excluir a reserva
    await fetch(`/api/reservas/${reserva.id || reserva.reserva_id}`, { method: "DELETE" });
  }
  // 5. Excluir o quarto
  const respQuarto = await fetch(`/api/quartos/${numero}`, { method: "DELETE" });
  if (respQuarto.ok) {
    alert("Quarto e todas as depend√™ncias exclu√≠dos!");
    // Atualize a interface
    const quartosAtualizados = await buscarQuartos();
    renderTabs(quartosAtualizados);
  } else {
    alert("Erro ao excluir quarto.");
  }
}


async function mostrarConsumosHospedeAtual(numeroQuarto) {
  // Buscar reserva ativa do quarto
  const respReserva = await fetch(`/api/reserva-ativa-quarto/${numeroQuarto}`);
  if (!respReserva.ok) {
    document.getElementById("dependencias-quarto").innerHTML = "<b>N√£o h√° h√≥spede atual neste quarto.</b>";
    return;
  }
  const reserva = await respReserva.json();
  // Buscar consumos da reserva ativa
  const respConsumos = await fetch(`/api/consumos?reserva_id=${reserva.id}`);
  const consumos = respConsumos.ok ? await respConsumos.json() : [];
  // Buscar produtos para mapear nomes
  const respProdutos = await fetch("/api/produtos");
  const produtos = respProdutos.ok ? await respProdutos.json() : [];
  const mapaProdutos = {};
  produtos.forEach(p => { mapaProdutos[p.id] = p.nome; });

  let html = `<b>Consumos do(a) ${reserva.nome_cliente}:</b>`; // <-- LINHA ALTERADA
  if (!consumos.length) {
    html += "<p>Nenhum consumo registrado.</p>";
  } else {
    html += `<table style="width:100%;margin-top:8px;border-collapse:collapse;">
      <tr>
        <th style="border:1px solid #ccc;padding:4px;">Produto</th>
        <th style="border:1px solid #ccc;padding:4px;">Quantidade</th>
        <th style="border:1px solid #ccc;padding:4px;">Valor Unit√°rio</th>
        <th style="border:1px solid #ccc;padding:4px;">Total</th>
      </tr>`;
    consumos.forEach(c => {
      html += `<tr>
        <td style="border:1px solid #ccc;padding:4px;">${mapaProdutos[c.produto_id] || c.produto_id}</td>
        <td style="border:1px solid #ccc;padding:4px;">${c.quantidade}</td>
        <td style="border:1px solid #ccc;padding:4px;">R$ ${Number(c.preco_unitario).toFixed(2)}</td>
        <td style="border:1px solid #ccc;padding:4px;">R$ ${(c.quantidade * c.preco_unitario).toFixed(2)}</td>
      </tr>`;
    });
    html += "</table>";
  }
  document.getElementById("dependencias-quarto").innerHTML = html;
}
    </script>
  </body>

</html>
