<!DOCTYPE html>
<html lang="pt-br">
  <head>
    <meta charset="UTF-8" />
    <title>Calendário de Ocupação de Quartos</title>
    <!-- Fonte e tema do dashboard -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
    <style>
      :root {
        --background-color: #f4f7fa;
        --sidebar-bg: #ffffff;
        --card-bg: #ffffff;
        --text-color: #4a5568;
        --heading-color: #1a202c;
        --primary-color: #4a90e2;
        --border-color: #e2e8f0;
        --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      }
      * { margin: 0; padding: 0; box-sizing: border-box; }
      body { font-family: "Inter", sans-serif; background: var(--background-color); color: var(--text-color); display: flex; }
      .container { display: flex; width: 100%; min-height: 100vh; }
      .sidebar { width: 240px; background: var(--sidebar-bg); padding: 2rem 1.5rem; display:flex; flex-direction:column; border-right:1px solid var(--border-color); }
      .sidebar-header { margin-bottom: 2.5rem; }
      .logo { font-size: 1.5rem; font-weight: 700; color: var(--heading-color); text-align:center; }
      .logo img { max-width: 100%; height: auto; }
      .date-time { text-align:center; font-size: 0.9rem; margin-top: 0.5rem; line-height: 1.4; }
      .nav-menu { flex-grow: 1; display:flex; flex-direction:column; gap:.5rem; }
      .menu-btn { display:flex; align-items:center; padding:.75rem 1rem; border-radius:8px; text-decoration:none; color:var(--text-color); font-weight:500; }
      .menu-btn:hover, .menu-btn.active { background: var(--primary-color); color:#fff; }
      .main-content { flex-grow:1; padding:2rem; overflow-y:auto; }
      .header { display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem; }
      h1 { font-size: 1.8rem; color: var(--heading-color); }

      /* Card container do calendário */
      .calendar-card { background: var(--card-bg); border-radius:12px; padding:1.5rem; box-shadow: var(--shadow); }
      .calendar-header { display:flex; align-items:center; gap:12px; margin-bottom: 1rem; }
      .calendar-header label { font-weight: 600; color: var(--heading-color); }
      .calendar-header input[type="month"], .calendar-quarto-select {
        padding: 0.6rem 0.8rem; border:1px solid var(--border-color); border-radius:8px; background:#fff; color:var(--text-color);
      }

      .legend { display:flex; gap:12px; align-items:center; margin-bottom: 0.75rem; }
      .legend span { display:inline-flex; align-items:center; gap:6px; font-size: .85rem; }
      .dot { width: 12px; height: 12px; border-radius: 3px; display:inline-block; }
      .dot.ocupado { background:#ff8a8a; }
      .dot.livre { background:#a8e6b0; }

      .calendar-table { width: 100%; border-collapse: collapse; }
      .calendar-table th, .calendar-table td {
        border: 1px solid var(--border-color); text-align: left; vertical-align: top; padding: 6px 8px; font-size: 0.9rem; position: relative; height: 64px;
      }
      .calendar-table thead th { background:#f8f9fa; text-align:center; font-weight:600; color: var(--heading-color); }

      .calendar-day-ocupado { background: #ffe2e2; cursor: pointer; }
      .calendar-day-livre { background: #f4fff6; }

      .back-link { text-decoration:none; color: var(--primary-color); font-weight:600; margin-right: .5rem; }

      @media (max-width: 768px) {
        body { flex-direction: column; }
        .sidebar { width: 100%; height:auto; border-right:none; border-bottom:1px solid var(--border-color); }
        .main-content { padding:1.5rem; }
        .header { flex-direction: column; align-items:flex-start; gap: 1rem; }
        .calendar-table th, .calendar-table td { font-size: 0.8rem; height: 54px; }
      }
    </style>
  </head>

  <body>
    <div class="container">
      <aside class="sidebar">
        <div class="sidebar-header">
          <div class="logo"><img src="imagens/LOGO HOTEL azul .svg.svg" alt="" /></div>
          <div class="date-time" id="dateTime"></div>
        </div>
        <nav class="nav-menu">
          <a href="checkin.html" class="menu-btn">Check-in</a>
          <a href="checkout.html" class="menu-btn">Check-out</a>
          <a href="clientes.html" class="menu-btn">Clientes</a>
          <a href="quartos.html" class="menu-btn">Quartos</a>
          <a href="reservas.html" class="menu-btn">Reservas</a>
          <a href="produtos.html" class="menu-btn">Produtos</a>
          <a href="calendario.html" class="menu-btn active">Calendário</a>
        </nav>
      </aside>

      <main class="main-content">
        <header class="header">
          <h1>Calendário</h1>
        </header>

        <section class="calendar-card">
          <div class="calendar-header">
            <a href="index.html" class="back-link">← Voltar</a>
            <label for="mes">Mês:</label>
            <input type="month" id="mes" />
            <label for="quartoSelect">Quarto:</label>
            <select id="quartoSelect" class="calendar-quarto-select"></select>
          </div>
          <div class="legend">
            <span><span class="dot ocupado"></span>Ocupado</span>
            <span><span class="dot livre"></span>Livre</span>
          </div>
          <div id="calendario"></div>
        </section>
      </main>
    </div>

    <script>
      let refreshInterval;

      function updateDateTime() {
        const now = new Date();
        const date = now.toLocaleDateString("pt-BR", { weekday: "long", year: "numeric", month: "long", day: "numeric" });
        const time = now.toLocaleTimeString("pt-BR", { hour: "2-digit", minute: "2-digit" });
        const el = document.getElementById("dateTime");
        if (el) el.innerHTML = `${date}<br>${time}`;
      }
      updateDateTime();
      setInterval(updateDateTime, 1000);

      document.addEventListener("DOMContentLoaded", () => {
        const hoje = new Date();
        document.getElementById("mes").value = hoje.toISOString().slice(0, 7);

        carregarCalendario();
        iniciarAutoRefresh();

        document.getElementById("mes").addEventListener("change", () => {
          carregarCalendario();
          iniciarAutoRefresh();
        });
      });

      function iniciarAutoRefresh() {
        if (refreshInterval) {
          clearInterval(refreshInterval);
        }
        refreshInterval = setInterval(carregarCalendario, 60000);
        console.log("Auto-refresh do calendário iniciado.");
      }

      async function carregarReservasEQuartos(ano, mes) {
        const primeiroDia = new Date(ano, mes - 1, 1).toISOString().slice(0, 10);
        const ultimoDia = new Date(ano, mes, 0).toISOString().slice(0, 10);

        const respReservas = await fetch(
          `/api/ocupacao-quartos?inicio=${primeiroDia}&fim=${ultimoDia}`
        );
        if (!respReservas.ok) {
          console.error("Falha ao buscar ocupação.");
          return { quartos: [], reservas: [] };
        }
        const reservas = await respReservas.json();

        const respQuartos = await fetch("/api/quartos");
        if (!respQuartos.ok) {
          console.error("Falha ao buscar quartos.");
          return { quartos: [], reservas: [] };
        }
        let quartos = await respQuartos.json();
        quartos.sort((a, b) => a.numero - b.numero);

        return { quartos, reservas };
      }

      async function carregarCalendario() {
        const calendarioDiv = document.getElementById("calendario");
        calendarioDiv.innerHTML = "Carregando...";

        const mesInput = document.getElementById("mes").value;
        const [ano, mes] = mesInput.split("-").map(Number);

        const { quartos, reservas } = await carregarReservasEQuartos(ano, mes);

        if (quartos.length === 0) {
          calendarioDiv.innerHTML = "Nenhum quarto cadastrado.";
          return;
        }
        montarCalendarioGantt(quartos, reservas, ano, mes);
      }

      function montarCalendarioGantt(quartos, reservas, ano, mes) {
        const diasNoMes = new Date(ano, mes, 0).getDate();
        const calendarioDiv = document.getElementById("calendario");

        let headerHtml = "<tr><th>Quarto</th>";
        for (let dia = 1; dia <= diasNoMes; dia++) {
          const data = new Date(ano, mes - 1, dia);
          const diaSemana = data.toLocaleDateString("pt-BR", { weekday: "short" }).slice(0, 3);
          const isWeekend = data.getDay() === 0 || data.getDay() === 6;
          headerHtml += `<th style="${isWeekend ? "background-color:#f8fafc;" : ""}">${dia}<br><small>${diaSemana}</small></th>`;
        }
        headerHtml += "</tr>";

        let bodyHtml = "";
        for (const quarto of quartos) {
          bodyHtml += `<tr><td><b>${quarto.numero}</b></td>`;

          const reservasDoQuarto = reservas.filter(
            (r) => r.quarto_numero == quarto.numero
          );

          let diaAtual = 1;
          while (diaAtual <= diasNoMes) {
            const dataAtual = new Date(ano, mes - 1, diaAtual);
            dataAtual.setHours(12);

            const reservaDoDia = reservasDoQuarto.find((r) => {
              const checkin = new Date(r.data_checkin);
              checkin.setHours(0, 0, 0, 0);
              const saida = new Date(r.data_saida_visual); // Usa a data para lógica
              saida.setHours(0, 0, 0, 0);
              return dataAtual >= checkin && dataAtual < saida;
            });

            if (reservaDoDia) {
              const checkin = new Date(reservaDoDia.data_checkin);
              checkin.setHours(0, 0, 0, 0);
              const saidaVisual = new Date(reservaDoDia.data_saida_visual);
              saidaVisual.setHours(0, 0, 0, 0);
              const saidaReal = new Date(reservaDoDia.data_saida_real); // Usa a data para exibir
              saidaReal.setHours(0, 0, 0, 0);

              let diaInicioNoMes = checkin.getMonth() + 1 === mes ? checkin.getDate() : 1;
              let diaFimNoMes;

              if (saidaVisual.getFullYear() === ano && saidaVisual.getMonth() + 1 === mes) {
                diaFimNoMes = saidaVisual.getDate() - 1;
              } else {
                diaFimNoMes = diasNoMes;
              }

              if (diaAtual > diaInicioNoMes) {
                diaInicioNoMes = diaAtual;
              }
              
              let diasDeOcupacao = diaFimNoMes - diaInicioNoMes + 1;
              if (diasDeOcupacao <= 0) {
                 bodyHtml += `<td class="calendar-day-livre" title="Disponível"></td>`;
                 diaAtual++;
                 continue;
              }

              const tooltipText = `Hóspede: ${reservaDoDia.cliente}\nPeríodo: ${formatarData(checkin)} a ${formatarData(saidaReal)}`; // Mostra data real

              bodyHtml += `<td colspan="${diasDeOcupacao}" class="calendar-day-ocupado" title="${tooltipText}">
                            <div style="font-size: 0.8em; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                                ${reservaDoDia.cliente}
                            </div>
                         </td>`;
              diaAtual += diasDeOcupacao;

            } else {
              // NOVO: Lógica para tooltip do dia do checkout
              const checkoutNesteDia = reservasDoQuarto.find(r => {
                  const saidaReal = new Date(r.data_saida_real);
                  return saidaReal.getFullYear() === dataAtual.getFullYear() &&
                         saidaReal.getMonth() === dataAtual.getMonth() &&
                         saidaReal.getDate() === dataAtual.getDate();
              });

              if (checkoutNesteDia) {
                  const tooltipText = `Disponível (Saída de ${checkoutNesteDia.cliente} neste dia)`;
                  bodyHtml += `<td class="calendar-day-livre" title="${tooltipText}"></td>`;
              } else {
                  bodyHtml += `<td class="calendar-day-livre" title="Disponível"></td>`;
              }
              diaAtual++;
            }
          }
          bodyHtml += "</tr>";
        }

        document.getElementById("quartoSelect").style.display = "none";
        document.querySelector("label[for='quartoSelect']").style.display = "none";

        calendarioDiv.innerHTML = `
        <div style="overflow-x: auto; border: 1px solid var(--border-color); border-radius: 8px;">
            <table class="calendar-table">
                <thead>${headerHtml}</thead>
                <tbody>${bodyHtml}</tbody>
            </table>
        </div>`;
      }

      function formatarData(data) {
        if (!data) return "";
        const d = new Date(data);
        const dia = String(d.getUTCDate()).padStart(2, "0");
        const mes = String(d.getUTCMonth() + 1).padStart(2, "0");
        return `${dia}/${mes}`;
      }
    </script>
  </body>
</html>
