<!DOCTYPE html>
<html lang="pt-br">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sistema Hotel - Clientes</title>
    <script>
      if (!sessionStorage.getItem('user') || !sessionStorage.getItem('token')) {
        window.location.replace('login.html');
      }
    </script>
    <!-- Importando a fonte Inter do Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link rel="icon" type="image/x-icon" href="imagens/logo_branco .svg" />
    <link
      rel="icon"
      type="image/png"
      sizes="32x32"
      href="imagens/logo_branco .svg"
    />
    <link rel="logo" href="imagens/logo_branco .svg" />
    <!-- Scripts de autentica√ß√£o e UI -->
    <script src="js/auth.js"></script>
    <script src="js/ui.js"></script>
    <!-- Estilos CSS para um visual minimalista e moderno -->
    <style>
      /* Reset b√°sico e configura√ß√µes globais */
      :root {
        --background-color: #f4f7fa;
        --sidebar-bg: #ffffff;
        --card-bg: #ffffff;
        --text-color: #4a5568;
        --heading-color: #1a202c;
        --primary-color: #4a90e2;
        --warning-color: #f6ad55;
        --danger-color: #e53e3e;
        --border-color: #e2e8f0;
        --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1),
          0 2px 4px -1px rgba(0, 0, 0, 0.06);
      }
      .main-flex {
        /* Mant√©m esta classe como container principal */
        display: flex;
        width: 100%;
        min-height: 100vh;
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      body {
        font-family: "Inter", sans-serif;
        background-color: var(--background-color); /* Corre√ß√£o: use var() */
        color: var(--text-color);
        display: flex; /* Mant√©m o body como flex container */
      }

      /* Removido container, usando main-flex que j√° existe */

      /* Estrutura principal com Flexbox */

      /* --- ESTILOS PADR√ÉO DA SIDEBAR (COPIADOS DE CALENDARIO.HTML) --- */
      .sidebar {
        width: 240px;
        background-color: #fff;
        padding: 2rem 1.5rem;
        display: flex;
        flex-direction: column;
        border-right: 1px solid var(--border-color);
        flex-shrink: 0;
        min-height: 100vh; /* Garante altura total */
      }
      .sidebar-header {
        margin-bottom: 2.5rem;
      }
      .logo {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--heading-color);
        text-align: center;
      }
      .logo img {
        height: auto;
      }
      .date-time {
        text-align: center;
        font-size: 0.9rem;
        margin-top: 0.5rem;
        line-height: 1.4;
        white-space: pre-line;
        min-height: 3rem;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .nav-menu {
        flex-grow: 1;
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
      }
      .menu-btn {
        display: flex;
        align-items: center;
        padding: 0.75rem 1rem;
        border-radius: 8px;
        text-decoration: none;
        color: var(--text-color);
        font-weight: 500;
        transition: background-color 0.2s, color 0.2s;
        /* Remove margin-bottom, j√° que gap no nav-menu cuida disso */
      }
      .menu-btn:hover,
      .menu-btn.active {
        background-color: var(--primary-color);
        color: #fff;
      }
      /* --- FIM DOS ESTILOS PADR√ÉO DA SIDEBAR --- */

      /* Estilos do User Card */
      .user-card {
        margin-top: auto;
        padding-top: 1.5rem;
        border-top: 1px solid var(--border-color);
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
      }

      .user-info {
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
      }

      .user-name {
        font-weight: 600;
        color: var(--heading-color);
        font-size: 0.95rem;
      }

      .user-role {
        font-size: 0.8rem;
        color: var(--text-color);
        opacity: 0.8;
      }

      .logout-btn {
        background-color: #e53e3e;
        color: white;
        border: none;
        padding: 0.6rem 1rem;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 600;
        font-size: 0.85rem;
        transition: all 0.2s;
      }

      .logout-btn:hover {
        background-color: #c53030;
      }

      /* Conte√∫do Principal */
      .main-content {
        flex-grow: 1;
        padding: 2rem;
        overflow-y: auto;
      }

      .header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 2rem;
      }

      .header-actions {
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .cadastro-btn {
        background-color: var(--primary-color);
        color: white;
        padding: 0.75rem 1.5rem;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
        font-size: 0.9rem;
        box-shadow: var(--shadow);
        transition: transform 0.15s ease, filter 0.2s ease;
      }

      .cadastro-btn:hover {
        filter: brightness(0.95);
        transform: translateY(-1px);
      }

      h1 {
        font-size: 1.8rem;
        color: var(--heading-color);
      }

      /* Cards para as se√ß√µes */
      .card {
        background-color: var(--card-bg);
        border-radius: 12px;
        padding: 1.5rem 2rem;
        box-shadow: var(--shadow);
        margin-bottom: 2rem;
      }

      .card-title {
        font-size: 1.2rem;
        font-weight: 600;
        color: var(--heading-color);
        margin-bottom: 1.5rem;
      }

      /* Estilos do Formul√°rio de Busca */
      .search-form {
        display: flex;
      }

      .search-form input {
        width: 100%;
        padding: 0.75rem 1rem;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        font-size: 1rem;
        font-family: "Inter", sans-serif;
        transition: border-color 0.2s, box-shadow 0.2s;
      }

      .search-form input:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.2);
      }

      /* Estilo das Tabelas */
      .table-wrapper {
        overflow-x: auto;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.9rem;
      }

      th,
      td {
        padding: 1rem;
        text-align: left;
        border-bottom: 1px solid var(--border-color);
        white-space: nowrap;
      }

      thead th {
        font-weight: 600;
        color: var(--heading-color);
        background-color: #f8f9fa;
      }

      tbody tr:last-child td {
        border-bottom: none;
      }

      tbody tr:hover {
        background-color: #f8f9fa;
      }

      td.actions-cell {
        display: flex;
        gap: 0.5rem;
      }

      .btn-action {
        padding: 0.5rem 1rem;
        font-size: 0.8rem;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        transition: background-color 0.2s;
        color: white;
      }

      .btn-edit {
        background-color: var(--warning-color);
      }

      .btn-edit:hover {
        background-color: #dd6b20;
      }

      .btn-delete {
        background-color: var(--danger-color);
      }

      .btn-delete:hover {
        background-color: #c53030;
      }

      .btn-save {
        background-color: #38a169;
      }

      .btn-save:hover {
        background-color: #2f855a;
      }

      .btn-cancel {
        background-color: #718096;
      }

      .btn-cancel:hover {
        background-color: #4a5568;
      }

      input.editable {
        width: 100%;
        min-width: 120px;
        padding: 0.5rem;
        border: 1px solid var(--border-color);
        border-radius: 6px;
        font-size: 0.9rem;
      }

      input.editable:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 2px rgba(74, 144, 226, 0.2);
      }

      /* Responsividade (Ajustada para o layout flex principal) */
      @media (max-width: 768px) {
        body {
          /* Mant√©m flex, mas permite quebra de linha */
        }
        .main-flex {
          flex-direction: column; /* Coloca sidebar em cima do conte√∫do */
        }
        .sidebar {
          width: 100%; /* Ocupa largura total */
          min-height: auto; /* Altura autom√°tica */
          border-right: none;
          border-bottom: 1px solid var(--border-color);
        }
        .main-content {
          padding: 1.5rem;
        }

        .header {
          /* Ajustes se necess√°rio para telas pequenas */
        }
      }
    </style>
  </head>

  <body>
    <div class="main-flex">
      <!-- ===== ESTRUTURA DA SIDEBAR ATUALIZADA ===== -->
      <aside class="sidebar">
        <div class="sidebar-header">
          <div class="logo">
            <img src="imagens/LOGO HOTEL azul .svg.svg" alt="Logo Hotel" />
            <!-- Adicionado alt text -->
          </div>
          <div class="date-time" id="dateTime"></div>
        </div>
        <nav class="nav-menu">
          <a href="index.html" class="menu-btn">üè† √çnicio</a>
          <a href="checkin.html" class="menu-btn">üì• Check-in</a>
          <a href="checkout.html" class="menu-btn">üì§ Check-out</a>
          <a href="clientes.html" class="menu-btn active">üë§ Clientes</a>
          <a href="quartos.html" class="menu-btn">üõèÔ∏è Quartos</a>
          <a href="reservas.html" class="menu-btn">üìã Reservas</a>
          <a href="produtos.html" class="menu-btn">üõí Produtos</a>
          <a href="calendario.html" class="menu-btn">üìÖ Calend√°rio</a>
          <a href="gerenciamento_usuarios.html" class="menu-btn" id="usuariosMenuBtn" style="display: none;">üë• Usu√°rios</a>
        </nav>
        <div class="user-card">
          <div class="user-info">
            <div class="user-name" id="sidebarUserName">‚Äî</div>
            <div class="user-role" id="sidebarUserRole">padr√£o</div>
          </div>
          <button class="logout-btn" id="sidebarLogoutBtn">Sair</button>
        </div>
      </aside>
      <!-- ===== FIM DA SIDEBAR ATUALIZADA ===== -->

      <div class="main-content">
        <header class="header">
          <h1>Gerenciar Clientes</h1>
          <div class="header-actions">
            <button class="cadastro-btn" onclick="window.location.href='cadastro_cliente.html'">
              + Cadastrar Cliente
            </button>
          </div>
        </header>

        <section class="card">
          <h2 class="card-title">Buscar Cliente</h2>
          <form class="search-form">
            <input
              type="text"
              id="searchInput"
              placeholder="Digite para buscar por nome, CPF ou passaporte..."
            />
          </form>
          <br />
          <h2 class="card-title">Clientes Cadastrados</h2>
          <div class="table-wrapper">
            <table>
              <thead>
                <tr>
                  <th>CPF</th>
                  <th>Nome</th>
                  <th>CEP</th>
                  <th>Endere√ßo</th>
                  <th>Telefone</th>
                  <th>Email</th>
                  <th>Passaporte</th>
                  <th>Data Nasc.</th>
                  <th>Nacionalidade</th>
                  <th>A√ß√µes</th>
                </tr>
              </thead>
              <tbody id="clientes-tbody">
                <!-- Dados dos clientes ser√£o inseridos aqui -->
              </tbody>
            </table>
          </div>
        </section>
      </div>
    </div>

    <script>
      // Filtra os clientes com base na busca
      function filterClientes() {
        const searchTerm = document
          .getElementById("searchInput")
          .value.trim()
          .toLowerCase();

        if (!searchTerm) {
          renderClientes(todosClientes);
          return;
        }

        const clientesFiltrados = todosClientes.filter((cliente) => {
          const nome = String(cliente.nome || "").toLowerCase();
          const cpf = String(cliente.cpf || "").toLowerCase();
          const passaporte = String(cliente.passaporte || "").toLowerCase();

          return (
            nome.includes(searchTerm) ||
            cpf.includes(searchTerm) ||
            passaporte.includes(searchTerm)
          );
        });
        renderClientes(clientesFiltrados);
      }

      let todosClientes = []; // Armazena a lista completa de clientes para filtro e cancelamento

      // Atualiza data e hora em tempo real
      function updateDateTime() {
        const now = new Date();
        const date = now.toLocaleDateString("pt-BR", {
          weekday: "long",
          year: "numeric",
          month: "long",
          day: "numeric",
        });
        const time = now.toLocaleTimeString("pt-BR", {
          hour: "2-digit",
          minute: "2-digit",
        });
        // Corre√ß√£o: Usar innerHTML para permitir a quebra de linha com <br>
        document.getElementById("dateTime").innerHTML = `${date}<br>${time}`;
      }
      updateDateTime();
      setInterval(updateDateTime, 1000);

      // Formata a data para o formato YYYY-MM-DD para o input
      function formatarDataParaInput(isoDate) {
        if (!isoDate) return "";
        // Garante que a data seja interpretada corretamente como UTC antes de formatar
        const data = new Date(isoDate);
        const offset = data.getTimezoneOffset();
        const dataUTC = new Date(data.getTime() + offset * 60 * 1000);
        return dataUTC.toISOString().split("T")[0];
      }

      function formatarCampo(valor) {
        // Verifica se √© null, undefined ou string vazia
        return valor != null && valor !== "" ? valor : "N/A";
      }

      // Renderiza a lista de clientes na tabela
      function renderClientes(clientes) {
        const tbody = document.getElementById("clientes-tbody");
        tbody.innerHTML = "";
        if (!Array.isArray(clientes) || clientes.length === 0) {
          // Verifica se √© array
          tbody.innerHTML =
            '<tr><td colspan="10">Nenhum cliente encontrado.</td></tr>';
          return;
        }
        clientes.forEach((cliente) => {
          const row = document.createElement("tr");
          // Usa o ID do banco se existir, sen√£o tenta CPF ou Passaporte como fallback
          row.id = `cliente-${
            cliente.id || cliente.cpf || cliente.passaporte || Math.random()
          }`; // Adiciona fallback aleat√≥rio se tudo for nulo
          row.innerHTML = getRowHtml(cliente);
          tbody.appendChild(row);
        });
      }

      // Gera o HTML de uma linha da tabela
      function getRowHtml(cliente) {
        // Valida√ß√£o defensiva para data_nascimento
        let dataNascimentoFormatada = "N/A";
        if (cliente.data_nascimento) {
          try {
            // Adiciona tratamento para interpretar a data corretamente como UTC
            const data = new Date(cliente.data_nascimento);
            const offset = data.getTimezoneOffset();
            const dataUTC = new Date(data.getTime() + offset * 60 * 1000);
            dataNascimentoFormatada = dataUTC.toLocaleDateString("pt-BR");
          } catch (e) {
            console.error(
              "Erro ao formatar data de nascimento:",
              cliente.data_nascimento,
              e
            );
            // Mant√©m "N/A" se houver erro
          }
        }

        return `
                <td>${formatarCampo(cliente.cpf)}</td>
                <td><span data-field="nome">${formatarCampo(
                  cliente.nome
                )}</span></td>
                <td>${formatarCampo(cliente.cep)}</td>
                <td><span data-field="endereco">${formatarCampo(
                  cliente.endereco
                )}</span></td>
                <td><span data-field="telefone">${formatarCampo(
                  cliente.telefone
                )}</span></td>
                <td><span data-field="email">${formatarCampo(
                  cliente.email
                )}</span></td>
                <td>${formatarCampo(cliente.passaporte)}</td>
                <td><span data-field="data_nascimento">${dataNascimentoFormatada}</span></td>
                <td><span data-field="nacionalidade">${formatarCampo(
                  cliente.nacionalidade
                )}</span></td>
                <td class="actions-cell">
                    <button class="btn-action btn-edit" onclick="editarCliente('${
                      cliente.id
                    }')">Editar</button>
                    <button class="btn-action btn-delete" onclick="deletarCliente('${
                      cliente.id
                    }')">Deletar</button>
                </td>
            `;
      }

      // Carrega os clientes da API
      async function carregarClientes() {
        const tbody = document.getElementById("clientes-tbody");
        tbody.innerHTML = '<tr><td colspan="10">Carregando...</td></tr>';
        try {
          const response = await fetch("/api/clientes");
          if (!response.ok) {
            // Verifica se a requisi√ß√£o foi bem sucedida
            throw new Error(
              `Erro na API: ${response.status} ${response.statusText}`
            );
          }
          todosClientes = await response.json();
          renderClientes(todosClientes);
        } catch (error) {
          tbody.innerHTML =
            '<tr><td colspan="10">Erro ao carregar clientes. Verifique a conex√£o com o servidor.</td></tr>';
          console.error("Erro ao carregar clientes:", error); // Log do erro
        }
      }

      // Habilita a edi√ß√£o em linha para um cliente
      function editarCliente(id) {
        const row = document.getElementById(`cliente-${id}`);
        if (!row || row.querySelector("input.editable")) return; // Impede edi√ß√µes m√∫ltiplas na mesma linha

        const cliente = todosClientes.find((c) => c.id == id); // Usa == para compara√ß√£o mais flex√≠vel
        if (!cliente) {
          console.error(
            "Cliente n√£o encontrado na lista local para edi√ß√£o:",
            id
          );
          return; // Sai se n√£o encontrar o cliente
        }

        row.querySelectorAll("span[data-field]").forEach((span) => {
          const field = span.dataset.field;
          // N√£o permite editar CPF diretamente na tabela (pode ser chave prim√°ria ou √∫nica)
          // if (field !== "cpf") { // Descomente se n√£o quiser permitir editar CPF
          let value = cliente[field] || ""; // Usa valor vazio se for null/undefined
          let inputType = "text";
          if (field === "data_nascimento") {
            inputType = "date";
            value = formatarDataParaInput(value); // Usa a fun√ß√£o para formatar
          } else if (field === "email") {
            inputType = "email"; // Usa tipo email para valida√ß√£o b√°sica
          } else if (field === "telefone") {
            inputType = "tel"; // Usa tipo tel
          }

          // Cria o input
          const input = document.createElement("input");
          input.type = inputType;
          input.className = "editable";
          input.dataset.field = field;
          input.value = value;

          // Limpa o span e adiciona o input
          span.textContent = ""; // Limpa o conte√∫do atual
          span.appendChild(input);
          // } // Fim do if (field !== "cpf")
        });

        // Atualiza a c√©lula de a√ß√µes com bot√µes Salvar/Cancelar
        const actionsCell = row.querySelector(".actions-cell");
        if (actionsCell) {
          // Verifica se a c√©lula de a√ß√µes existe
          actionsCell.innerHTML = `
                <button class="btn-action btn-save" onclick="salvarCliente('${id}')">Salvar</button>
                <button class="btn-action btn-cancel" onclick="cancelarEdicao('${id}')">Cancelar</button>
             `;
        } else {
          console.error("C√©lula de a√ß√µes n√£o encontrada para a linha:", id);
        }
      }

      // Cancela a edi√ß√£o e restaura a linha
      function cancelarEdicao(id) {
        const clienteOriginal = todosClientes.find(
          (c) => String(c.id) === String(id)
        ); // Compara√ß√£o mais segura
        if (clienteOriginal) {
          const row = document.getElementById(`cliente-${id}`);
          if (row) {
            // Verifica se a linha existe
            row.innerHTML = getRowHtml(clienteOriginal); // Regenera o HTML da linha
          } else {
            console.error("Linha n√£o encontrada para cancelar edi√ß√£o:", id);
          }
        } else {
          console.error(
            "Cliente original n√£o encontrado para cancelar edi√ß√£o:",
            id
          );
        }
      }

      // Salva as altera√ß√µes do cliente
      async function salvarCliente(id) {
        const row = document.getElementById(`cliente-${id}`);
        if (!row) {
          alert("Erro: Linha da tabela n√£o encontrada para salvar.");
          return;
        }

        const clienteOriginal = todosClientes.find(
          (c) => String(c.id) === String(id)
        );
        if (!clienteOriginal) {
          alert(
            "Erro: n√£o foi poss√≠vel encontrar os dados originais do cliente."
          );
          return;
        }

        const inputs = row.querySelectorAll("input.editable");
        const dataToSend = { ...clienteOriginal }; // Come√ßa com os dados originais
        let algumCampoVazio = false;

        // Itera sobre os inputs para coletar os novos valores
        inputs.forEach((input) => {
          const field = input.dataset.field;
          const value = input.value.trim(); // Remove espa√ßos extras

          // Valida√ß√£o simples de campo vazio (exceto para campos que podem ser vazios como passaporte)
          if (
            !value &&
            field !== "passaporte" /* Adicione outros campos opcionais aqui */
          ) {
            alert(`O campo "${field}" n√£o pode ficar em branco.`);
            algumCampoVazio = true;
          }
          dataToSend[field] = value; // Atualiza o objeto com o novo valor
        });

        // Se algum campo obrigat√≥rio estiver vazio, interrompe o salvamento
        if (algumCampoVazio) {
          return;
        }

        // Valida√ß√£o adicional: CPF ou Passaporte deve existir (se aplic√°vel √†s suas regras)
        // if (!dataToSend.cpf && !dataToSend.passaporte) {
        //     alert("√â necess√°rio preencher o CPF ou o Passaporte.");
        //     return;
        // }

        try {
          const response = await fetch(`/api/clientes/${id}`, {
            // Usa o ID original na URL
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(dataToSend), // Envia o objeto atualizado
          });

          if (response.ok) {
            alert("Cliente atualizado com sucesso!");
            // Atualiza o objeto na lista local 'todosClientes'
            Object.assign(clienteOriginal, dataToSend);
            cancelarEdicao(id); // Restaura a visualiza√ß√£o da linha
          } else {
            const errorData = await response.json().catch(() => ({
              message: "Erro desconhecido ao processar resposta.",
            })); // Trata erro no JSON
            alert(
              `Erro ao atualizar cliente: ${
                errorData.message || response.statusText
              }`
            );
          }
        } catch (error) {
          console.error("Erro de conex√£o ao salvar cliente:", error);
          alert("Erro de conex√£o ao salvar cliente. Verifique o console.");
        }
      }

      // Deleta um cliente
      async function deletarCliente(id) {
        // Adiciona um null check para o ID
        if (!id) {
          alert("Erro: ID do cliente inv√°lido.");
          return;
        }

        if (
          confirm(
            "Tem certeza que deseja deletar este cliente? Esta a√ß√£o n√£o pode ser desfeita."
          )
        ) {
          try {
            // Adiciona try...catch
            const response = await fetch(`/api/clientes/${id}`, {
              method: "DELETE",
            });
            if (response.ok) {
              alert("Cliente deletado com sucesso!");
              // Remove o cliente da lista local e recarrega a tabela
              todosClientes = todosClientes.filter(
                (c) => String(c.id) !== String(id)
              );
              renderClientes(todosClientes); // Renderiza a lista atualizada
            } else {
              const errorData = await response.json().catch(() => ({
                message: "Erro desconhecido ao processar resposta.",
              }));
              alert(errorData.message || "Erro ao deletar cliente.");
            }
          } catch (error) {
            console.error("Erro de conex√£o ao deletar cliente:", error);
            alert("Erro de conex√£o ao deletar cliente. Verifique o console.");
          }
        }
      }

      // Inicializa a p√°gina
      document.addEventListener("DOMContentLoaded", () => {
        carregarClientes();
        const searchInput = document.getElementById("searchInput");
        if (searchInput) {
          // Verifica se o input de busca existe
          searchInput.addEventListener("input", filterClientes);
        }
      });
    </script>
  </body>
</html>
