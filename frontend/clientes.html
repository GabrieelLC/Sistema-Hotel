<!DOCTYPE html>
<html lang="pt-br">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sistema Hotel - Clientes</title>
    <!-- Importando a fonte Inter do Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />

    <!-- Estilos CSS para um visual minimalista e moderno -->
    <style>
      /* Reset básico e configurações globais */
      :root {
        --background-color: #f4f7fa;
        --sidebar-bg: #ffffff;
        --card-bg: #ffffff;
        --text-color: #4a5568;
        --heading-color: #1a202c;
        --primary-color: #4a90e2;
        --warning-color: #f6ad55;
        --danger-color: #e53e3e;
        --border-color: #e2e8f0;
        --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1),
          0 2px 4px -1px rgba(0, 0, 0, 0.06);
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      body {
        font-family: "Inter", sans-serif;
        background-color: var(--background-color); /* Correção: use var() */
        color: var(--text-color);
        display: flex; /* Mantém o body como flex container */
      }

      /* Removido container, usando main-flex que já existe */

      /* Estrutura principal com Flexbox */
      .main-flex {
        /* Mantém esta classe como container principal */
        display: flex;
        width: 100%;
        min-height: 100vh;
      }

      /* --- ESTILOS PADRÃO DA SIDEBAR (COPIADOS DE CALENDARIO.HTML) --- */
      .sidebar {
        width: 240px;
        background-color: var(--sidebar-bg);
        padding: 2rem 1.5rem;
        display: flex;
        flex-direction: column;
        border-right: 1px solid var(--border-color);
        flex-shrink: 0;
        min-height: 100vh; /* Garante altura total */
      }
      .sidebar-header {
        margin-bottom: 2.5rem;
      }
      .logo {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--heading-color);
        text-align: center;
      }
      .logo img {
        max-width: 140px; /* Ajuste conforme necessário */
        height: auto;
      }
      .date-time {
        text-align: center;
        font-size: 0.9rem;
        margin-top: 0.5rem;
        line-height: 1.4;
        white-space: pre-line; /* Permite quebras de linha com \n no JS */
      }
      .nav-menu {
        flex-grow: 1;
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
      }
      .menu-btn {
        display: flex;
        align-items: center;
        padding: 0.75rem 1rem;
        border-radius: 8px;
        text-decoration: none;
        color: var(--text-color);
        font-weight: 500;
        transition: background-color 0.2s, color 0.2s;
        /* Remove margin-bottom, já que gap no nav-menu cuida disso */
      }
      .menu-btn:hover,
      .menu-btn.active {
        background-color: var(--primary-color);
        color: #fff;
      }
      /* --- FIM DOS ESTILOS PADRÃO DA SIDEBAR --- */

      /* Conteúdo Principal */
      .main-content {
        flex-grow: 1;
        padding: 2rem;
        overflow-y: auto;
      }

      .header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 2rem;
      }

      h1 {
        font-size: 1.8rem;
        color: var(--heading-color);
      }

      /* Cards para as seções */
      .card {
        background-color: var(--card-bg);
        border-radius: 12px;
        padding: 1.5rem 2rem;
        box-shadow: var(--shadow);
        margin-bottom: 2rem;
      }

      .card-title {
        font-size: 1.2rem;
        font-weight: 600;
        color: var(--heading-color);
        margin-bottom: 1.5rem;
      }

      /* Estilos do Formulário de Busca */
      .search-form {
        display: flex;
      }

      .search-form input {
        width: 100%;
        padding: 0.75rem 1rem;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        font-size: 1rem;
        font-family: "Inter", sans-serif;
        transition: border-color 0.2s, box-shadow 0.2s;
      }

      .search-form input:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.2);
      }

      /* Estilo das Tabelas */
      .table-wrapper {
        overflow-x: auto;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.9rem;
      }

      th,
      td {
        padding: 1rem;
        text-align: left;
        border-bottom: 1px solid var(--border-color);
        white-space: nowrap;
      }

      thead th {
        font-weight: 600;
        color: var(--heading-color);
        background-color: #f8f9fa;
      }

      tbody tr:last-child td {
        border-bottom: none;
      }

      tbody tr:hover {
        background-color: #f8f9fa;
      }

      td.actions-cell {
        display: flex;
        gap: 0.5rem;
      }

      .btn-action {
        padding: 0.5rem 1rem;
        font-size: 0.8rem;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        transition: background-color 0.2s;
        color: white;
      }

      .btn-edit {
        background-color: var(--warning-color);
      }

      .btn-edit:hover {
        background-color: #dd6b20;
      }

      .btn-delete {
        background-color: var(--danger-color);
      }

      .btn-delete:hover {
        background-color: #c53030;
      }

      .btn-save {
        background-color: #38a169;
      }

      .btn-save:hover {
        background-color: #2f855a;
      }

      .btn-cancel {
        background-color: #718096;
      }

      .btn-cancel:hover {
        background-color: #4a5568;
      }

      input.editable {
        width: 100%;
        min-width: 120px;
        padding: 0.5rem;
        border: 1px solid var(--border-color);
        border-radius: 6px;
        font-size: 0.9rem;
      }

      input.editable:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 2px rgba(74, 144, 226, 0.2);
      }

      /* Responsividade (Ajustada para o layout flex principal) */
      @media (max-width: 768px) {
        body {
          /* Mantém flex, mas permite quebra de linha */
        }
        .main-flex {
          flex-direction: column; /* Coloca sidebar em cima do conteúdo */
        }
        .sidebar {
          width: 100%; /* Ocupa largura total */
          min-height: auto; /* Altura automática */
          border-right: none;
          border-bottom: 1px solid var(--border-color);
        }
        .main-content {
          padding: 1.5rem;
        }

        .header {
          /* Ajustes se necessário para telas pequenas */
        }
      }
    </style>
  </head>

  <body>
    <div class="main-flex">
      <!-- ===== ESTRUTURA DA SIDEBAR ATUALIZADA ===== -->
      <aside class="sidebar">
        <div class="sidebar-header">
          <div class="logo">
            <img src="imagens/LOGO HOTEL azul .svg.svg" alt="Logo Hotel" />
            <!-- Adicionado alt text -->
          </div>
          <div class="date-time" id="dateTime"></div>
        </div>
        <nav class="nav-menu">
          <a href="index.html" class="menu-btn">Ínicio</a>
          <a href="checkin.html" class="menu-btn">Check-in</a>
          <a href="checkout.html" class="menu-btn">Check-out</a>
          <a href="clientes.html" class="menu-btn active">Clientes</a>
          <a href="quartos.html" class="menu-btn">Quartos</a>
          <a href="reservas.html" class="menu-btn">Reservas</a>
          <a href="produtos.html" class="menu-btn">Produtos</a>
          <a href="calendario.html" class="menu-btn">Calendário</a>
        </nav>
      </aside>
      <!-- ===== FIM DA SIDEBAR ATUALIZADA ===== -->

      <div class="main-content">
        <header class="header">
          <h1>Gerenciar Clientes</h1>
        </header>

        <section class="card">
          <h2 class="card-title">Buscar Cliente</h2>
          <form class="search-form">
            <input
              type="text"
              id="searchInput"
              placeholder="Digite para buscar por nome, CPF ou passaporte..."
            />
          </form>
          <br />
          <h2 class="card-title">Clientes Cadastrados</h2>
          <div class="table-wrapper">
            <table>
              <thead>
                <tr>
                  <th>CPF</th>
                  <th>Nome</th>
                  <th>CEP</th>
                  <th>Endereço</th>
                  <th>Telefone</th>
                  <th>Email</th>
                  <th>Passaporte</th>
                  <th>Data Nasc.</th>
                  <th>Nacionalidade</th>
                  <th>Ações</th>
                </tr>
              </thead>
              <tbody id="clientes-tbody">
                <!-- Dados dos clientes serão inseridos aqui -->
              </tbody>
            </table>
          </div>
        </section>
      </div>
    </div>

    <script>
      // Filtra os clientes com base na busca
      function filterClientes() {
        const searchTerm = document
          .getElementById("searchInput")
          .value.trim()
          .toLowerCase();

        if (!searchTerm) {
          renderClientes(todosClientes);
          return;
        }

        const clientesFiltrados = todosClientes.filter((cliente) => {
          const nome = String(cliente.nome || "").toLowerCase();
          const cpf = String(cliente.cpf || "").toLowerCase();
          const passaporte = String(cliente.passaporte || "").toLowerCase();

          return (
            nome.includes(searchTerm) ||
            cpf.includes(searchTerm) ||
            passaporte.includes(searchTerm)
          );
        });
        renderClientes(clientesFiltrados);
      }

      let todosClientes = []; // Armazena a lista completa de clientes para filtro e cancelamento

      // Atualiza data e hora em tempo real
      function updateDateTime() {
        const now = new Date();
        const date = now.toLocaleDateString("pt-BR", {
          weekday: "long",
          year: "numeric",
          month: "long",
          day: "numeric",
        });
        const time = now.toLocaleTimeString("pt-BR", {
          hour: "2-digit",
          minute: "2-digit",
        });
        // Correção: Usar innerHTML para permitir a quebra de linha com <br>
        document.getElementById("dateTime").innerHTML = `${date}<br>${time}`;
      }
      updateDateTime();
      setInterval(updateDateTime, 1000);

      // Formata a data para o formato YYYY-MM-DD para o input
      function formatarDataParaInput(isoDate) {
        if (!isoDate) return "";
        // Garante que a data seja interpretada corretamente como UTC antes de formatar
        const data = new Date(isoDate);
        const offset = data.getTimezoneOffset();
        const dataUTC = new Date(data.getTime() + offset * 60 * 1000);
        return dataUTC.toISOString().split("T")[0];
      }

      function formatarCampo(valor) {
        // Verifica se é null, undefined ou string vazia
        return valor != null && valor !== "" ? valor : "N/A";
      }

      // Renderiza a lista de clientes na tabela
      function renderClientes(clientes) {
        const tbody = document.getElementById("clientes-tbody");
        tbody.innerHTML = "";
        if (!Array.isArray(clientes) || clientes.length === 0) {
          // Verifica se é array
          tbody.innerHTML =
            '<tr><td colspan="10">Nenhum cliente encontrado.</td></tr>';
          return;
        }
        clientes.forEach((cliente) => {
          const row = document.createElement("tr");
          // Usa o ID do banco se existir, senão tenta CPF ou Passaporte como fallback
          row.id = `cliente-${
            cliente.id || cliente.cpf || cliente.passaporte || Math.random()
          }`; // Adiciona fallback aleatório se tudo for nulo
          row.innerHTML = getRowHtml(cliente);
          tbody.appendChild(row);
        });
      }

      // Gera o HTML de uma linha da tabela
      function getRowHtml(cliente) {
        // Validação defensiva para data_nascimento
        let dataNascimentoFormatada = "N/A";
        if (cliente.data_nascimento) {
          try {
            // Adiciona tratamento para interpretar a data corretamente como UTC
            const data = new Date(cliente.data_nascimento);
            const offset = data.getTimezoneOffset();
            const dataUTC = new Date(data.getTime() + offset * 60 * 1000);
            dataNascimentoFormatada = dataUTC.toLocaleDateString("pt-BR");
          } catch (e) {
            console.error(
              "Erro ao formatar data de nascimento:",
              cliente.data_nascimento,
              e
            );
            // Mantém "N/A" se houver erro
          }
        }

        return `
                <td>${formatarCampo(cliente.cpf)}</td>
                <td><span data-field="nome">${formatarCampo(
                  cliente.nome
                )}</span></td>
                <td>${formatarCampo(cliente.cep)}</td>
                <td><span data-field="endereco">${formatarCampo(
                  cliente.endereco
                )}</span></td>
                <td><span data-field="telefone">${formatarCampo(
                  cliente.telefone
                )}</span></td>
                <td><span data-field="email">${formatarCampo(
                  cliente.email
                )}</span></td>
                <td>${formatarCampo(cliente.passaporte)}</td>
                <td><span data-field="data_nascimento">${dataNascimentoFormatada}</span></td>
                <td><span data-field="nacionalidade">${formatarCampo(
                  cliente.nacionalidade
                )}</span></td>
                <td class="actions-cell">
                    <button class="btn-action btn-edit" onclick="editarCliente('${
                      cliente.id
                    }')">Editar</button>
                    <button class="btn-action btn-delete" onclick="deletarCliente('${
                      cliente.id
                    }')">Deletar</button>
                </td>
            `;
      }

      // Carrega os clientes da API
      async function carregarClientes() {
        const tbody = document.getElementById("clientes-tbody");
        tbody.innerHTML = '<tr><td colspan="10">Carregando...</td></tr>';
        try {
          const response = await fetch("/api/clientes");
          if (!response.ok) {
            // Verifica se a requisição foi bem sucedida
            throw new Error(
              `Erro na API: ${response.status} ${response.statusText}`
            );
          }
          todosClientes = await response.json();
          renderClientes(todosClientes);
        } catch (error) {
          tbody.innerHTML =
            '<tr><td colspan="10">Erro ao carregar clientes. Verifique a conexão com o servidor.</td></tr>';
          console.error("Erro ao carregar clientes:", error); // Log do erro
        }
      }

      // Habilita a edição em linha para um cliente
      function editarCliente(id) {
        const row = document.getElementById(`cliente-${id}`);
        if (!row || row.querySelector("input.editable")) return; // Impede edições múltiplas na mesma linha

        const cliente = todosClientes.find((c) => c.id == id); // Usa == para comparação mais flexível
        if (!cliente) {
          console.error(
            "Cliente não encontrado na lista local para edição:",
            id
          );
          return; // Sai se não encontrar o cliente
        }

        row.querySelectorAll("span[data-field]").forEach((span) => {
          const field = span.dataset.field;
          // Não permite editar CPF diretamente na tabela (pode ser chave primária ou única)
          // if (field !== "cpf") { // Descomente se não quiser permitir editar CPF
          let value = cliente[field] || ""; // Usa valor vazio se for null/undefined
          let inputType = "text";
          if (field === "data_nascimento") {
            inputType = "date";
            value = formatarDataParaInput(value); // Usa a função para formatar
          } else if (field === "email") {
            inputType = "email"; // Usa tipo email para validação básica
          } else if (field === "telefone") {
            inputType = "tel"; // Usa tipo tel
          }

          // Cria o input
          const input = document.createElement("input");
          input.type = inputType;
          input.className = "editable";
          input.dataset.field = field;
          input.value = value;

          // Limpa o span e adiciona o input
          span.textContent = ""; // Limpa o conteúdo atual
          span.appendChild(input);
          // } // Fim do if (field !== "cpf")
        });

        // Atualiza a célula de ações com botões Salvar/Cancelar
        const actionsCell = row.querySelector(".actions-cell");
        if (actionsCell) {
          // Verifica se a célula de ações existe
          actionsCell.innerHTML = `
                <button class="btn-action btn-save" onclick="salvarCliente('${id}')">Salvar</button>
                <button class="btn-action btn-cancel" onclick="cancelarEdicao('${id}')">Cancelar</button>
             `;
        } else {
          console.error("Célula de ações não encontrada para a linha:", id);
        }
      }

      // Cancela a edição e restaura a linha
      function cancelarEdicao(id) {
        const clienteOriginal = todosClientes.find(
          (c) => String(c.id) === String(id)
        ); // Comparação mais segura
        if (clienteOriginal) {
          const row = document.getElementById(`cliente-${id}`);
          if (row) {
            // Verifica se a linha existe
            row.innerHTML = getRowHtml(clienteOriginal); // Regenera o HTML da linha
          } else {
            console.error("Linha não encontrada para cancelar edição:", id);
          }
        } else {
          console.error(
            "Cliente original não encontrado para cancelar edição:",
            id
          );
        }
      }

      // Salva as alterações do cliente
      async function salvarCliente(id) {
        const row = document.getElementById(`cliente-${id}`);
        if (!row) {
          alert("Erro: Linha da tabela não encontrada para salvar.");
          return;
        }

        const clienteOriginal = todosClientes.find(
          (c) => String(c.id) === String(id)
        );
        if (!clienteOriginal) {
          alert(
            "Erro: não foi possível encontrar os dados originais do cliente."
          );
          return;
        }

        const inputs = row.querySelectorAll("input.editable");
        const dataToSend = { ...clienteOriginal }; // Começa com os dados originais
        let algumCampoVazio = false;

        // Itera sobre os inputs para coletar os novos valores
        inputs.forEach((input) => {
          const field = input.dataset.field;
          const value = input.value.trim(); // Remove espaços extras

          // Validação simples de campo vazio (exceto para campos que podem ser vazios como passaporte)
          if (
            !value &&
            field !== "passaporte" /* Adicione outros campos opcionais aqui */
          ) {
            alert(`O campo "${field}" não pode ficar em branco.`);
            algumCampoVazio = true;
          }
          dataToSend[field] = value; // Atualiza o objeto com o novo valor
        });

        // Se algum campo obrigatório estiver vazio, interrompe o salvamento
        if (algumCampoVazio) {
          return;
        }

        // Validação adicional: CPF ou Passaporte deve existir (se aplicável às suas regras)
        // if (!dataToSend.cpf && !dataToSend.passaporte) {
        //     alert("É necessário preencher o CPF ou o Passaporte.");
        //     return;
        // }

        try {
          const response = await fetch(`/api/clientes/${id}`, {
            // Usa o ID original na URL
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(dataToSend), // Envia o objeto atualizado
          });

          if (response.ok) {
            alert("Cliente atualizado com sucesso!");
            // Atualiza o objeto na lista local 'todosClientes'
            Object.assign(clienteOriginal, dataToSend);
            cancelarEdicao(id); // Restaura a visualização da linha
          } else {
            const errorData = await response.json().catch(() => ({
              message: "Erro desconhecido ao processar resposta.",
            })); // Trata erro no JSON
            alert(
              `Erro ao atualizar cliente: ${
                errorData.message || response.statusText
              }`
            );
          }
        } catch (error) {
          console.error("Erro de conexão ao salvar cliente:", error);
          alert("Erro de conexão ao salvar cliente. Verifique o console.");
        }
      }

      // Deleta um cliente
      async function deletarCliente(id) {
        // Adiciona um null check para o ID
        if (!id) {
          alert("Erro: ID do cliente inválido.");
          return;
        }

        if (
          confirm(
            "Tem certeza que deseja deletar este cliente? Esta ação não pode ser desfeita."
          )
        ) {
          try {
            // Adiciona try...catch
            const response = await fetch(`/api/clientes/${id}`, {
              method: "DELETE",
            });
            if (response.ok) {
              alert("Cliente deletado com sucesso!");
              // Remove o cliente da lista local e recarrega a tabela
              todosClientes = todosClientes.filter(
                (c) => String(c.id) !== String(id)
              );
              renderClientes(todosClientes); // Renderiza a lista atualizada
            } else {
              const errorData = await response.json().catch(() => ({
                message: "Erro desconhecido ao processar resposta.",
              }));
              alert(errorData.message || "Erro ao deletar cliente.");
            }
          } catch (error) {
            console.error("Erro de conexão ao deletar cliente:", error);
            alert("Erro de conexão ao deletar cliente. Verifique o console.");
          }
        }
      }

      // Inicializa a página
      document.addEventListener("DOMContentLoaded", () => {
        carregarClientes();
        const searchInput = document.getElementById("searchInput");
        if (searchInput) {
          // Verifica se o input de busca existe
          searchInput.addEventListener("input", filterClientes);
        }
      });
    </script>
  </body>
</html>
