<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Tela de Check-out</title>
    <link rel="icon" type="image/x-icon" href="imagens/logo_branco .svg" />
    <link
      rel="icon"
      type="image/png"
      sizes="32x32"
      href="imagens/logo_branco .svg"
    />
    <link rel="logo" href="imagens/logo_branco .svg" />
    <style>
      :root {
        --background-color: #f4f7fa;
        --sidebar-bg: #ffffff;
        --card-bg: #ffffff;
        --text-color: #4a5568;
        --heading-color: #1a202c;
        --primary-color: #4a90e2;
        --border-color: #e2e8f0;
        --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1),
          0 2px 4px -1px rgba(0, 0, 0, 0.06);
      }

      body {
        display: flex;
        background-color: var(--background-color);
        color: var(--text-color);
        font-family: "Inter", sans-serif;
      }

      .container {
        display: flex;
        width: 100%;
        min-height: 100vh;
      }
      .sidebar {
        width: 240px;
        background-color: var(--sidebar-bg);
        padding: 2rem 1.5rem;
        display: flex;
        flex-direction: column;
        border-right: 1px solid var(--border-color);
        transition: width 0.3s;
      }
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      .sidebar-header {
        margin-bottom: 2.5rem;
      }

      .logo {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--heading-color);
        text-align: center;
      }

      .date-time {
        text-align: center;
        font-size: 0.9rem;
        margin-top: 0.5rem;
        line-height: 1.4;
      }

      .nav-menu {
        flex-grow: 1;
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
      }

      .menu-btn {
        display: flex;
        align-items: center;
        padding: 0.75rem 1rem;
        border-radius: 8px;
        text-decoration: none;
        color: var(--text-color);
        font-weight: 500;
        transition: background-color 0.2s, color 0.2s;
      }

      .menu-btn:hover,
      .menu-btn.active {
        background-color: var(--primary-color);
        color: #fff;
      }

      /* ===== Main Content ===== */
      .main-content {
        flex-grow: 1;
        padding: 2rem;
        overflow: auto;
      }

      /* ===== Estilos do Check-out ===== */
      .checkout_screen_container {
        background-color: #ffffff;
        color: #333;
        padding: 30px;
        border-radius: 10px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        width: 100%;
        max-width: 800px;
        margin: 0 auto;
      }

      .checkout_screen_header {
        display: flex;
        align-items: center;
        margin-bottom: 25px;
      }

      .checkout_screen_back_arrow {
        font-size: 28px;
        text-decoration: none;
        color: #555;
        margin-right: 20px;
        cursor: pointer;
      }

      .checkout_screen_title_box {
        background-color: #357abd;
        color: white;
        padding: 10px 20px;
        border-radius: 8px;
        text-align: center;
        flex-grow: 1;
      }

      .checkout_screen_main_title {
        margin: 0;
        font-size: 24px;
        font-weight: 500;
      }

      .checkout_screen_form {
        width: 100%;
      }

      .checkout_screen_columns_wrapper {
        display: flex;
        gap: 40px;
        flex-wrap: wrap;
      }

      .checkout_screen_column {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 15px;
      }

      .checkout_screen_field_group {
        display: flex;
        flex-direction: column;
      }

      .checkout_screen_label {
        margin-bottom: 6px;
        font-weight: 500;
        color: #555;
      }

      .checkout_screen_input {
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 5px;
        font-size: 16px;
        width: 100%;
        box-sizing: border-box;
      }

      .checkout_screen_input:focus {
        outline: none;
        border-color: #357abd;
        box-shadow: 0 0 5px rgba(53, 122, 189, 0.5);
      }

      .checkout_screen_input--small {
        width: 80px !important;
      }

      .checkout_screen_consumption_table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 5px;
      }

      .checkout_screen_table_head {
        background-color: #f7f7f7;
      }

      .checkout_screen_table_header,
      .checkout_screen_table_cell {
        border: 1px solid #ddd;
        padding: 10px;
        text-align: left;
      }

      .checkout_screen_table_header {
        font-weight: 600;
      }

      .checkout_screen_footer {
        display: flex;
        justify-content: flex-end;
        margin-top: 30px;
      }

      .checkout_screen_submit_button {
        background-color: #357abd;
        color: white;
        border: none;
        padding: 12px 25px;
        border-radius: 8px;
        font-size: 16px;
        font-weight: bold;
        cursor: pointer;
        transition: background-color 0.3s ease;
      }

      .checkout_screen_submit_button:hover {
        background-color: #2c639a;
      }
    </style>
  </head>

  <body>
    <div class="container">
      <!-- Sidebar -->
      <aside class="sidebar">
        <div class="sidebar-header">
          <div class="logo">
            <img src="imagens/LOGO HOTEL azul .svg.svg" alt="Logo" />
          </div>
          <div class="date-time" id="dateTime"></div>
        </div>
        <nav class="nav-menu">
          <a href="index.html" class="menu-btn">Início</a>
          <a href="checkin.html" class="menu-btn">Check-in</a>
          <a href="checkout.html" class="menu-btn active">Check-out</a>
          <a href="clientes.html" class="menu-btn">Clientes</a>
          <a href="quartos.html" class="menu-btn">Quartos</a>
          <a href="reservas.html" class="menu-btn">Reservas</a>
          <a href="produtos.html" class="menu-btn">Produtos</a>
          <a href="calendario.html" class="menu-btn">Calendário</a>
        </nav>
      </aside>

      <!-- Conteúdo principal -->
      <main class="main-content">
        <div class="checkout_screen_container">
          <header class="checkout_screen_header">
            <a
              href="#"
              class="checkout_screen_back_arrow"
              onclick="VoltarPagina()"
              >←</a
            >
            <div class="checkout_screen_title_box">
              <h1 class="checkout_screen_main_title">Check-out</h1>
            </div>
          </header>

          <form class="checkout_screen_form">
            <div class="checkout_screen_columns_wrapper">
              <div class="checkout_screen_column">
                <div class="checkout_screen_field_group">
                  <label for="cpf_cliente">CPF ou Passaporte cliente:</label>
                  <input
                    type="text"
                    id="cpf_cliente"
                    name="cpf"
                    class="checkout_screen_input"
                  />
                </div>
                <div class="checkout_screen_field_group">
                  <label class="checkout_screen_label" for="valor_diaria"
                    >Valor da diária</label
                  >
                  <input
                    type="text"
                    id="valor_diaria"
                    name="valor-diaria"
                    class="checkout_screen_input"
                  />
                </div>
                <div class="checkout_screen_field_group">
                  <label class="checkout_screen_label" for="qtd_dias"
                    >Quantidade de dias</label
                  >
                  <input
                    type="number"
                    id="qtd_dias"
                    name="qtd-dias"
                    class="checkout_screen_input checkout_screen_input--small"
                  />
                </div>
                <div class="checkout_screen_field_group">
                  <label class="checkout_screen_label" for="total"
                    >Total a pagar</label
                  >
                  <input
                    type="text"
                    id="total"
                    name="total"
                    class="checkout_screen_input"
                    readonly
                  />
                </div>
              </div>

              <div class="checkout_screen_column">
                <div class="checkout_screen_field_group">
                  <label class="checkout_screen_label" for="data_checkout"
                    >Data Check-out:</label
                  >
                  <input
                    type="date"
                    id="data_checkout"
                    name="data-checkout"
                    class="checkout_screen_input"
                  />
                </div>
                <div class="checkout_screen_field_group">
                  <label class="checkout_screen_label" for="hora_checkout"
                    >Hora Check-out:</label
                  >
                  <input
                    type="time"
                    id="hora_checkout"
                    name="hora-checkout"
                    class="checkout_screen_input"
                  />
                </div>
                <div class="checkout_screen_field_group">
                  <label class="checkout_screen_label" for="quarto"
                    >Quarto</label
                  >
                  <input
                    type="text"
                    id="quarto"
                    class="checkout_screen_input checkout_screen_input--small"
                    readonly
                  />
                </div>
                <div class="checkout_screen_field_group">
                  <label class="checkout_screen_label">Consumo</label>
                  <table class="checkout_screen_consumption_table">
                    <thead class="checkout_screen_table_head">
                      <tr>
                        <th class="checkout_screen_table_header">Produto</th>
                        <th class="checkout_screen_table_header">Quantidade</th>
                        <th class="checkout_screen_table_header">Total</th>
                      </tr>
                    </thead>
                    <tbody class="checkout_screen_table_body"></tbody>
                  </table>
                </div>
              </div>
            </div>

            <div class="checkout_screen_footer">
              <button type="submit" class="checkout_screen_submit_button">
                Registrar
              </button>
            </div>
          </form>
        </div>
      </main>
    </div>

    <script src="https://unpkg.com/imask"></script>

    <script>
      function updateDateTime() {
        const now = new Date();
        const date = now.toLocaleDateString("pt-BR", {
          weekday: "long",
          year: "numeric",
          month: "long",
          day: "numeric",
        });
        const time = now.toLocaleTimeString("pt-BR", {
          hour: "2-digit",
          minute: "2-digit",
        });
        document.getElementById("dateTime").innerHTML = `${date}<br>${time}`;
      }
      updateDateTime();
      setInterval(updateDateTime, 1000);

      function VoltarPagina() {
        window.history.back();
      }

      // === Script original preservado ===
      document.addEventListener("DOMContentLoaded", function () {
        var horaInput = document.getElementById("hora_checkout");
        var maskOptions = {
          mask: "00:00",
          blocks: {
            "00": {
              mask: IMask.MaskedRange,
              from: 0,
              to: 23,
              maxLength: 2,
            },
            "00": {
              mask: IMask.MaskedRange,
              from: 0,
              to: 59,
              maxLength: 2,
            },
          },
        };
        var mask = IMask(horaInput, maskOptions);

        const dataInput = document.getElementById("data_checkout");
        const horaInput2 = document.getElementById("hora_checkout");
        const now = new Date();
        dataInput.value = now.toISOString().slice(0, 10);
        horaInput2.value = now.toTimeString().slice(0, 5);
      });

      let reservaAtivaId = null;

      document
        .getElementById("cpf_cliente")
        .addEventListener("blur", async function () {
          const cpf = this.value.trim();
          if (!cpf) return;

          document.getElementById("valor_diaria").value = "";
          document.getElementById("qtd_dias").value = "";
          document.getElementById("total").value = "";
          document.getElementById("quarto").value = "";
          reservaAtivaId = null;

          try {
            const resp = await fetch(`/api/reserva-ativa/${cpf}`);
            if (!resp.ok) {
              alert("Nenhuma reserva ativa encontrada para este CPF.");
              return;
            }
            const reserva = await resp.json();
            preencherFormularioCheckout(reserva);
          } catch (error) {
            alert("Erro ao buscar reserva ativa");
          }
        });

      document
        .querySelector(".checkout_screen_form")
        .addEventListener("submit", async function (e) {
          e.preventDefault();

          if (!reservaAtivaId) {
            alert("Busque o CPF do cliente primeiro!");
            return;
          }

          const data_checkout = document.getElementById("data_checkout").value;
          const hora_checkout = document.getElementById("hora_checkout").value;

          const resp = await fetch(`/api/checkout/${reservaAtivaId}`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ data_checkout, hora_checkout }),
          });

          if (resp.ok) {
            alert("Checkout realizado com sucesso!");
          } else {
            const erro = await resp.json();
            alert("Erro ao registrar checkout: " + (erro.message || ""));
          }
        });

      async function preencherFormularioCheckout(reserva) {
        reservaAtivaId = reserva.id;
        document.getElementById("valor_diaria").value =
          reserva.valor_diaria || "";
        document.getElementById("quarto").value = reserva.quarto || "";

        const dataCheckin = new Date(reserva.data_checkin);
        const dataCheckout = new Date(
          document.getElementById("data_checkout").value
        );
        const diffTime = Math.abs(dataCheckout - dataCheckin);
        let diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        if (diffDays === 0) diffDays = 1;
        document.getElementById("qtd_dias").value = diffDays;

        const respConsumos = await fetch(`/api/consumos/${reserva.id}`);
        const consumos = await respConsumos.json();
        const tbody = document.querySelector(".checkout_screen_table_body");
        tbody.innerHTML = "";
        let totalConsumos = 0;
        if (consumos.length) {
          consumos.forEach((c) => {
            const totalItem = c.quantidade * c.preco_unitario;
            totalConsumos += totalItem;
            tbody.innerHTML += `
              <tr>
                <td class="checkout_screen_table_cell">${c.produto_nome}</td>
                <td class="checkout_screen_table_cell">${c.quantidade}</td>
                <td class="checkout_screen_table_cell">${totalItem.toFixed(
                  2
                )}</td>
              </tr>`;
          });
        } else {
          tbody.innerHTML =
            '<tr><td colspan="3" class="checkout_screen_table_cell">Nenhum consumo registrado</td></tr>';
        }

        function calcularTotal() {
          const dias = Number(document.getElementById("qtd_dias").value) || 1;
          const valorDiaria =
            Number(document.getElementById("valor_diaria").value) || 0;
          const total = valorDiaria * dias + totalConsumos;
          document.getElementById("total").value = total.toFixed(2);
        }

        document
          .getElementById("qtd_dias")
          .addEventListener("input", calcularTotal);
        document
          .getElementById("valor_diaria")
          .addEventListener("input", calcularTotal);

        calcularTotal();
      }
    </script>
  </body>
</html>
